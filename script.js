(function(){const STORAGE_KEY='contador4_prompts_v4';const EXAMPLES=[{categoria:'finanzas',nombre:'Análisis Express Rentabilidad PYME',cuando:'Cliente pregunta por qué bajó utilidad',personalizacion:'Sector retail Colombia; lenguaje simple',tiempo:20,frecuencia:'semanal',ejemplo:'Distribuidora: problema capital de trabajo; ahorro $15M',contenido:'Analiza las partidas clave (ventas, COGS, gastos operativos) y genera un plan de 3 acciones priorizadas para mejorar la rentabilidad en los próximos 90 días, incluyendo impacto estimado en pesos.'},{categoria:'clientes',nombre:'Propuesta Premium de Servicios Contables',cuando:'Prospecto solicita cotización o upgrade',personalizacion:'Dirigida a Gerente; énfasis en ROI',tiempo:30,frecuencia:'mensual',ejemplo:'Cerré 3 upgrades; aumento promedio 40% en honorarios',contenido:'Crea una propuesta comercial de una página que destaque beneficios, métricas esperadas (ahorro/ingresos), plazos y ROI proyectado en 6 meses.'},{categoria:'automatizacion',nombre:'Calendario Fiscal Automatizado',cuando:'Inicio de mes para planificar obligaciones',personalizacion:'Régimen común; formato tabla con alertas',tiempo:15,frecuencia:'mensual',ejemplo:'Evité 2 multas por vencimientos',contenido:"Genera un calendario fiscal mensual en formato tabla con fechas de vencimiento, responsable y una columna 'alerta' con reglas para recordatorio 7 días antes."},{categoria:'automatizacion',nombre:'Reporte Ejecutivo Semanal con IA',cuando:'Todos los lunes para clientes premium',personalizacion:'Máximo 1 página; 3 métricas clave',tiempo:12,frecuencia:'semanal',ejemplo:'Cliente aceptó aumento de 25% en retainer',contenido:'Resume las 3 métricas financieras clave (ventas, margen, cashflow) y su tendencia semanal. Incluye 2 recomendaciones accionables.'},{categoria:'nómina',nombre:'Detección de Irregularidades en Nómina',cuando:'Antes de procesar nómina mensual',personalizacion:'Detectar duplicados y empleados fantasma',tiempo:25,frecuencia:'mensual',ejemplo:'Detecté empleado duplicado; ahorro $3.2M/año',contenido:'Analiza la nómina y detecta patrones: duplicados, horas extras inusuales y empleados sin actividad. Genera lista priorizada y sugerencias de corrección.'}];const tbody=document.querySelector('#promptsTable tbody');const fab=document.getElementById('fab');const modal=document.getElementById('modal');const modalForm=document.getElementById('modalForm');const cancelModal=document.getElementById('cancelModal');const exportBtn=document.getElementById('exportTopBtn');const clearBtn=document.getElementById('clearAllBtn');const detail=document.getElementById('detailPanel');const dName=document.getElementById('d-name');const dSub=document.getElementById('d-sub');const dCategoria=document.getElementById('d-categoria');const dContenido=document.getElementById('d-contenido');function readStorage(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return null;return JSON.parse(raw)}catch(e){return null}}function writeStorage(arr){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(arr))}catch(e){}}function ensureSeed(){const data=readStorage();if(!data||!Array.isArray(data)||data.length===0){writeStorage(EXAMPLES.slice());return EXAMPLES.slice()}return data}function escapeHtml(s){if(s===undefined||s===null)return'';return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}function truncate(s,n){if(!s)return'';return s.length>n?s.slice(0,n-1)+'…':s}function capitalize(s){if(!s)return'';return s.charAt(0).toUpperCase()+s.slice(1)}function render(){const data=ensureSeed();tbody.innerHTML='';data.forEach((r,i)=>{const tr=document.createElement('tr');if(i<EXAMPLES.length)tr.style.background='linear-gradient(90deg, rgba(255,244,224,0.8), transparent)';tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(r.categoria||'')}</td><td><a class="prompt-link" data-index="${i}">${escapeHtml(r.nombre)}</a></td><td>${escapeHtml(truncate(r.cuando,80))}</td><td>${escapeHtml(truncate(r.personalizacion||'',60))}</td><td>${escapeHtml(String(r.tiempo||''))}</td><td>${escapeHtml(capitalize(r.frecuencia||''))}</td><td><button class="btn btn-ghost btn-delete" data-index="${i}">Eliminar</button></td>`;tbody.appendChild(tr)})}fab.addEventListener('click',()=>{modal.style.display='flex';document.getElementById('m-nombre').focus()});cancelModal.addEventListener('click',()=>{modal.style.display='none';modalForm.reset()});modalForm.addEventListener('submit',function(e){e.preventDefault();const categoria=document.getElementById('m-categoria').value;const nombre=document.getElementById('m-nombre').value.trim();const cuando=document.getElementById('m-cuando').value.trim();const personalizacion=document.getElementById('m-personalizacion').value.trim();const tiempo=Number(document.getElementById('m-tiempo').value)||0;const frecuencia=document.getElementById('m-frecuencia').value;const ejemplo=document.getElementById('m-ejemplo').value.trim();const contenido=document.getElementById('m-contenido').value.trim();if(!nombre||!cuando||!ejemplo||!contenido){alert('Completa los campos obligatorios');return}const cur=readStorage()||[];cur.push({categoria,nombre,cuando,personalizacion,tiempo,frecuencia,ejemplo,contenido});writeStorage(cur);render();modal.style.display='none';modalForm.reset()});tbody.addEventListener('click',function(e){const a=e.target.closest('.prompt-link');if(a){const idx=Number(a.dataset.index);openDetail(idx);return}const del=e.target.closest('.btn-delete');if(del){const idx=Number(del.dataset.index);if(!confirm('¿Eliminar este prompt?'))return;let arr=readStorage()||[];arr.splice(idx,1);writeStorage(arr);render()}});function openDetail(idx){const arr=ensureSeed();const item=arr[idx];if(!item)return;dName.textContent=item.nombre||'';dSub.textContent=item.personalizacion||'';dCategoria.textContent=item.categoria||'';dContenido.textContent=item.contenido||'';detail.style.display='block';document.getElementById('biblioteca').style.display='none'}document.getElementById('backBtn')?.addEventListener('click',()=>{detail.style.display='none';document.getElementById('biblioteca').style.display=''});clearBtn.addEventListener('click',()=>{if(!confirm('¿Restablecer ejemplos iniciales?'))return;writeStorage(EXAMPLES.slice());render();alert('Restablecido a ejemplos iniciales')});exportBtn.addEventListener('click',()=>{exportXLSX()});function exportXLSX(){const arr=readStorage()||[];if(!arr.length){alert('No hay prompts para exportar');return}const ws1=[['Categoria','Nombre','Cuándo Usar','Personalización','Tiempo (min)','Frecuencia','Ejemplo de Uso','Contenido del Prompt']];arr.forEach(r=>ws1.push([r.categoria||'',r.nombre||'',r.cuando||'',r.personalizacion||'',r.tiempo||'',r.frecuencia||'',r.ejemplo||'',r.contenido||'']));const instructions=[['Instrucciones de uso - Biblioteca de Prompts — Contador 4.0 (Desarrollado por Jairo Amaya)'],[],['1. Agregar Prompt: usa el botón (+) para completar la ficha con el prompt real que usas en la IA.'],['2. Editar: abre un prompt y presiona \"Editar\" para modificarlo.'],['3. Eliminar: usa el ícono de basura para borrar un prompt individual.'],['4. Limpiar Biblioteca: restablece los 5 ejemplos iniciales.'],['5. Exportar a Excel: genera este archivo con dos hojas: Biblioteca e Instrucciones.'],[],['Tips:'],['- Usa la columna \"Categoria\" para filtrar por tema (finanzas, clientes, automatización, nómina, otros).'],['- Guarda copia de seguridad en Google Drive si trabajas en equipo.']];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ws1),'Biblioteca');XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(instructions),'Instrucciones');const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});const blob=new Blob([wbout],{type:'application/octet-stream'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='Biblioteca_Prompts_Contador4.xlsx';document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove()},1500)}render();